<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>코딩 캔버스 (Coding Canvas)</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f6f7f9; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb;
    --shadow:0 10px 20px rgba(0,0,0,.06);
    --footer-h: 56px;
    --splitter-w: 8px;
    --left-col: 1fr;          /* 드래그로 변경 */
    --vh: 100dvh;             /* JS가 실제 높이로 업데이트 */
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  html.dark{ --bg:#0b1020; --panel:#141a2f; --text:#e5e7eb; --muted:#a3acc2; --border:#2a3350; --accent:#60a5fa; --shadow:0 10px 20px rgba(0,0,0,.25); }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  /* 페이지 뼈대: sticky footer 보장 */
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
    min-height:var(--vh);                 /* 모바일 100vh 버그 회피 */
    display:flex; flex-direction:column;
  }
  /* 편집 영역(좌/스플리터/우) 전용 그리드 */
  .app{
    flex:1; min-height:0;
    display:grid;
    grid-template-columns: var(--left-col) var(--splitter-w) 1fr;
    grid-auto-rows:auto;
  }

  .left, .right{ min-height:calc(var(--vh) - var(--footer-h)); display:flex; flex-direction:column; min-width:0; }
  .left{ grid-column:1; border-right:1px solid var(--border); }
  .right{ grid-column:3; }

  /* 분할바 */
  .splitter{
    grid-column:2; align-self:stretch;
    background:var(--border);
    cursor:col-resize;
    width:var(--splitter-w);
    position:relative; user-select:none;
    touch-action:none;
  }
  .splitter::after{
    content:""; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:2px; height:28px; border-radius:2px; background:rgba(0,0,0,.18);
  }
  .splitter:hover, .splitter.dragging{ background:var(--accent); }
  .splitter.dragging::after{ background:#fff; }

  /* 드래그 캡처용 오버레이 */
  .drag-overlay{
    position:fixed; inset:0; z-index:9999;
    cursor:col-resize; background:transparent;
    touch-action:none;
  }

  .topbar{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:var(--panel); }
  .logo img{ height:96px; display:block; cursor:pointer; }
  .iconbar{ display:flex; align-items:center; gap:8px; overflow-x:auto; scrollbar-width:thin; -webkit-overflow-scrolling:touch; }
  .iconbtn{ border:1px solid var(--border); background:#fff0; color:var(--text); padding:10px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; min-width:42px; min-height:42px; box-shadow:var(--shadow); flex:0 0 auto; }
  .iconbtn:hover{ background:rgba(0,0,0,0.04) }
  .iconbtn.active{ border-color:var(--accent); background:color-mix(in srgb, var(--accent) 12%, transparent); }
  .iconbtn svg{ width:20px; height:20px; display:block; }

  .tabs{ display:flex; gap:6px; padding:8px 10px; border-bottom:1px solid var(--border); background:var(--panel); overflow-x:auto; scrollbar-width:thin; -webkit-overflow-scrolling:touch; }
  .tab{ border:1px solid var(--border); background:#fff0; color:var(--muted); padding:8px 12px; border-radius:10px; cursor:pointer; flex:0 0 auto; }
  .tab.active{ color:var(--accent); border-color:var(--accent); background:color-mix(in srgb, var(--accent) 8%, transparent); }

  .editor{ width:100%; height:100%; border:0; outline:none; padding:14px; resize:none; font:13px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Fira Code', monospace; background:var(--bg); color:var(--text); }
  .hidden{ display:none }

  .previewbar{ display:flex; align-items:center; justify-content:flex-end; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:var(--panel); }
  .preview{ flex:1; display:flex; align-items:center; justify-content:center; padding:10px; overflow:auto; min-height:240px; }
  iframe{ width:100%; height:100%; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:var(--shadow); }
  .w375{ width:375px !important; }

  footer{
    border-top:1px solid var(--border); background:var(--panel);
    height:var(--footer-h);
    padding-bottom:var(--safe-bottom);           /* 아이폰 하단 홈바 안전영역 */
  }
  footer .wrap{ height:100%; display:flex; align-items:center; justify-content:center; gap:8px; padding:0 12px; text-align:center; }
  footer a{ color:inherit; text-decoration:none; }
  footer a:hover{ text-decoration:underline; }

  dialog{ border:1px solid var(--border); border-radius:12px; background:var(--bg); color:var(--text); padding:0; width:min(92vw,420px); }
  dialog::backdrop{ background:rgba(0,0,0,.35); }
  dialog header{ padding:12px 14px; border-bottom:1px solid var(--border); font-weight:700; }
  dialog .body{ padding:14px; }
  dialog .actions{ display:flex; gap:8px; justify-content:flex-end; padding:12px 14px; border-top:1px solid var(--border); }
  .radio-row{ display:flex; align-items:center; gap:10px; padding:8px 0; }
  .help{ color:var(--muted); font-size:12px; margin-top:6px; }

  /* 반응형: 좁은 폭에서는 1열 스택 + sticky 툴바 */
  @media (max-width: 900px){
    .app{ grid-template-columns:1fr; grid-auto-rows:auto; }
    .left, .right{ min-height:auto; }
    .splitter{ display:none; }
    .logo img{ height:84px; }
    .iconbtn{ min-width:44px; min-height:44px; }
    .editor{ font-size:14px; }
    .topbar, .previewbar{ position:sticky; top:0; z-index:20; }
    .preview{ min-height:calc(50vh - 80px); } /* 프리뷰 최소 높이 확보 */
  }
</style>
</head>
<body>
  <!-- 편집/미리보기 영역 -->
  <main class="app">
    <!-- LEFT -->
    <section class="left">
      <div class="topbar">
        <a class="logo" href="#" onclick="CC.hardReset(); return false;" title="처음 화면으로">
          <img src="https://i.ibb.co/Jw8sLtRy/002-2.png" alt="Coding Canvas Logo">
        </a>
        <div class="iconbar">
          <button id="run" class="iconbtn" title="실행" aria-label="실행" onclick="CC.render()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21 5,3" fill="currentColor"></polygon></svg>
          </button>
          <button id="autorunBtn" class="iconbtn" title="자동실행" aria-label="자동실행(토글)" onclick="CC.toggleAuto()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"></path></svg>
          </button>
          <button id="theme" class="iconbtn" title="라이트/다크 전환" aria-label="테마 전환" onclick="CC.toggleTheme()">
            <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
            </svg>
          </button>
          <button id="save" class="iconbtn" title="다운로드" aria-label="다운로드" onclick="CC.openDownload()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v10"></path><path d="M7 12l5 5 5-5"></path><rect x="3" y="17" width="18" height="4" rx="1"></rect></svg>
          </button>
          <input id="loadInput" type="file" accept=".json,.txt,.html,.htm,.css,.js" class="hidden" />
          <button id="load" class="iconbtn" title="불러오기 / 파일 열기" aria-label="불러오기" onclick="document.getElementById('loadInput').click()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h6l2 2h10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"></path><path d="M3 12h18"></path></svg>
          </button>
          <button id="reset" class="iconbtn" title="초기화" aria-label="초기화" onclick="CC.reset()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-3-6.7"></path><path d="M21 3v6h-6"></path></svg>
          </button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" type="button" data-for="html" onclick="CC.switchTab('html')">HTML</button>
        <button class="tab" type="button" data-for="css" onclick="CC.switchTab('css')">CSS</button>
        <button class="tab" type="button" data-for="js" onclick="CC.switchTab('js')">JS</button>
      </div>

      <div style="flex:1; min-height:0; position:relative;">
        <textarea id="html" class="editor" spellcheck="false"><h1>안녕하세요!</h1>
<p>왼쪽에서 코드를 입력하고, <strong>실행</strong> 버튼을 눌러보세요.</p>
<button onclick="showAlert()">클릭해보세요</button></textarea>

        <textarea id="css" class="editor hidden" spellcheck="false">body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
  padding: 20px;
  background: #eaf3ff;
  text-align: center;
}
h1{ color:#1e40af }
button{
  background:#2563eb; color:white; border:0; padding:10px 18px; border-radius:10px;
}
button:hover{ filter:brightness(.95) }</textarea>

        <textarea id="js" class="editor hidden" spellcheck="false">function showAlert(){
  const box = document.createElement('div');
  box.textContent = '버튼이 클릭되었습니다! ' + new Date().toLocaleTimeString();
  box.style.cssText = 'margin-top:20px;padding:12px;border:1px solid #93c5fd;background:#dbeafe;border-radius:10px;color:#1e40af';
  document.body.appendChild(box);
}
console.log('콘솔 테스트: 정상 동작');</textarea>
      </div>
    </section>

    <!-- SPLITTER -->
    <div id="splitter" class="splitter" title="드래그하여 폭 조절"></div>

    <!-- RIGHT -->
    <section class="right">
      <div class="previewbar">
        <button id="desktop" class="iconbtn active" title="데스크톱" aria-label="데스크톱" onclick="CC.setDesktop()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="12" rx="2"></rect><path d="M8 20h8"></path></svg>
        </button>
        <button id="mobile" class="iconbtn" title="모바일(375px)" aria-label="모바일" onclick="CC.setMobile()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="7" y="2" width="10" height="20" rx="2"></rect><circle cx="12" cy="18" r="1"></circle></svg>
        </button>
      </div>
      <div class="preview">
        <iframe id="view" title="미리보기"></iframe>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <a href="https://litt.ly/chichiboo" target="_blank" rel="noopener noreferrer">created by. 교육뮤지컬 꿈꾸는 치수쌤</a>
    </div>
  </footer>

  <dialog id="dlDialog">
    <header>다운로드</header>
    <div class="body">
      <div class="radio-row"><input type="radio" name="fmt" id="fmt_json" value="json" checked><label for="fmt_json">JSON (프로젝트 전체 저장)</label></div>
      <div class="radio-row"><input type="radio" name="fmt" id="fmt_txt" value="txt"><label for="fmt_txt">TXT (구분자 포함한 텍스트)</label></div>
      <div class="radio-row"><input type="radio" name="fmt" id="fmt_html" value="html"><label for="fmt_html">HTML (실행 가능한 단일 파일)</label></div>
      <div class="help">확인을 누르면 선택한 형식으로 파일을 저장합니다.</div>
    </div>
    <div class="actions">
      <button class="iconbtn" onclick="CC.closeDownload()">취소</button>
      <button class="iconbtn active" onclick="CC.confirmDownload()">확인</button>
    </div>
  </dialog>

<script>
  /* ===== 실제 뷰포트 높이를 CSS 변수로 반영(모바일 100vh 버그 해결) ===== */
  (function(){
    const setVH = ()=>{
      const h = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', h + 'px');
    };
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
  })();

  const CC = (function(){
    const el = {
      html: document.getElementById('html'),
      css: document.getElementById('css'),
      js: document.getElementById('js'),
      view: document.getElementById('view'),
      autorunBtn: document.getElementById('autorunBtn'),
      themeIcon: document.getElementById('themeIcon'),
      desktop: document.getElementById('desktop'),
      mobile: document.getElementById('mobile'),
      dlDialog: document.getElementById('dlDialog'),
      loadInput: document.getElementById('loadInput'),
      splitter: document.getElementById('splitter'),
      root: document.documentElement
    };

    let autoOn = true;
    function setAuto(on){ autoOn = !!on; el.autorunBtn.classList.toggle('active', autoOn); }
    function switchTab(which){
      document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.for===which));
      [el.html, el.css, el.js].forEach(t => t.classList.toggle('hidden', t.id!==which));
    }

    function buildDoc(){
      return `<!doctype html>
<html><head><meta charset="utf-8"><style>${el.css.value}</style></head>
<body>${el.html.value}<script>${el.js.value}<\/script></body></html>`;
    }

    function setPreviewContent(docStr){
      try{
        el.view.removeAttribute('sandbox'); el.view.srcdoc = docStr;
        setTimeout(()=>{ try{
          const ok = !!(el.view.contentDocument && el.view.contentDocument.body && el.view.contentDocument.body.childNodes.length);
          if(!ok){ const d = el.view.contentWindow.document; d.open(); d.write(docStr); d.close(); }
        }catch(_){} }, 40);
      }catch(_){
        try{ const d = el.view.contentWindow.document; d.open(); d.write(docStr); d.close(); }
        catch(__){ const blob = new Blob([docStr], {type:'text/html'}); const url = URL.createObjectURL(blob); el.view.src = url; setTimeout(()=>URL.revokeObjectURL(url), 2000); }
      }
    }

    function render(){ setPreviewContent(buildDoc()); }
    function toggleAuto(){ setAuto(!autoOn); }

    function setThemeIcon(dark){
      el.themeIcon.innerHTML = dark
        ? '<path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"></path>'
        : '<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>';
    }
    function toggleTheme(){
      const dark = !document.documentElement.classList.contains('dark');
      document.documentElement.classList.toggle('dark', dark);
      localStorage.setItem('cc_v7_theme', dark ? 'dark':'light');
      setThemeIcon(dark);
    }

    function setDesktop(){ el.desktop.classList.add('active'); el.mobile.classList.remove('active'); el.view.classList.remove('w375'); }
    function setMobile(){ el.mobile.classList.add('active'); el.desktop.classList.remove('active'); el.view.classList.add('w375'); }

    function openDownload(){ if (typeof el.dlDialog.showModal === 'function') el.dlDialog.showModal(); else el.dlDialog.setAttribute('open','open'); }
    function closeDownload(){ if (typeof el.dlDialog.close === 'function') el.dlDialog.close(); else el.dlDialog.removeAttribute('open'); }
    function confirmDownload(){
      const fmt = (document.querySelector('input[name="fmt"]:checked')||{}).value || 'json';
      const download = (filename, text, type)=>{ const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1000); };
      if(fmt==='json'){ download('coding-canvas.json', JSON.stringify({html:el.html.value, css:el.css.value, js:el.js.value}, null, 2), 'application/json'); }
      else if(fmt==='txt'){ download('coding-canvas.txt', ['===HTML===',el.html.value.trim(),'===CSS===',el.css.value.trim(),'===JS===',el.js.value.trim()].join('\n'), 'text/plain'); }
      else { download('coding-canvas.html', buildDoc(), 'text/html'); }
      closeDownload();
    }

    function reset(){ if(!confirm('초기 상태로 되돌릴까요?')) return; el.html.value=DEFAULTS.html; el.css.value=DEFAULTS.css; el.js.value=DEFAULTS.js; render(); }
    function hardReset(){
      ['cc_v7_html','cc_v7_css','cc_v7_js','cc_v7_theme','cc_v7_split'].forEach(k=>localStorage.removeItem(k));
      el.html.value=DEFAULTS.html; el.css.value=DEFAULTS.css; el.js.value=DEFAULTS.js;
      document.documentElement.classList.remove('dark'); setThemeIcon(false);
      setDesktop(); setAuto(true); el.root.style.setProperty('--left-col','1fr'); render();
    }

    /* ===== Splitter with overlay (iframe-safe) ===== */
    function setupSplitter(){
      const s = el.splitter; if(!s) return;
      const MIN = 240;

      function getSplitW(){
        const v = getComputedStyle(document.documentElement).getPropertyValue('--splitter-w');
        const n = parseInt(v,10); return isNaN(n)?8:n;
      }
      function clamp(px){
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth||0);
        const max = vw - getSplitW() - 240;
        return Math.max(MIN, Math.min(px, max));
      }
      function setLeft(px){ el.root.style.setProperty('--left-col', px+'px'); localStorage.setItem('cc_v7_split', String(px)); }

      let overlay=null;
      function move(clientX){
        const rect = document.body.getBoundingClientRect();
        setLeft(clamp(clientX - rect.left));
      }
      function onMove(e){
        const x = (e.touches? e.touches[0].clientX : e.clientX);
        move(x);
      }
      function stop(){
        s.classList.remove('dragging');
        if(overlay){ overlay.removeEventListener('pointermove', onMove); overlay.removeEventListener('pointerup', stop); overlay.removeEventListener('pointercancel', stop); overlay.remove(); overlay=null; }
      }
      function start(e){
        e.preventDefault();
        s.classList.add('dragging');
        overlay = document.createElement('div');
        overlay.className = 'drag-overlay';
        document.body.appendChild(overlay);
        overlay.addEventListener('pointermove', onMove);
        overlay.addEventListener('pointerup', stop);
        overlay.addEventListener('pointercancel', stop);
        onMove(e); // 시작 위치 반영
      }

      s.addEventListener('pointerdown', start);
      s.addEventListener('dblclick', ()=>{ // 더블클릭: 50:50
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth||0);
        setLeft(Math.round((vw - getSplitW())/2));
      });

      const saved = parseInt(localStorage.getItem('cc_v7_split')||'0',10); if(saved>0) setLeft(saved);
      window.addEventListener('resize', ()=>{
        const cur = parseInt(getComputedStyle(el.root).getPropertyValue('--left-col'),10);
        if(!isNaN(cur)) setLeft(clamp(cur));
      });
    }

    // typing debounce + tab indent
    let t;
    [el.html, el.css, el.js].forEach(ed=>{
      ed.addEventListener('input', ()=>{
        localStorage.setItem('cc_v7_html', el.html.value);
        localStorage.setItem('cc_v7_css',  el.css.value);
        localStorage.setItem('cc_v7_js',   el.js.value);
        if(!autoOn) return; clearTimeout(t); t=setTimeout(render,240);
      });
      ed.addEventListener('keydown', (e)=>{
        if(e.key==='Tab'){ e.preventDefault(); const s=ed.selectionStart, epos=ed.selectionEnd; ed.value=ed.value.substring(0,s)+'  '+ed.value.substring(epos); ed.selectionStart=ed.selectionEnd=s+2; if(autoOn){ clearTimeout(t); t=setTimeout(render,240); } }
      });
    });

    const DEFAULTS = { html: el.html.value, css: el.css.value, js: el.js.value };
    function init(){
      const theme = localStorage.getItem('cc_v7_theme');
      const dark = theme==='dark' || (theme!=='light' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.classList.toggle('dark', dark); setThemeIcon(dark);

      const hs = localStorage.getItem('cc_v7_html'); if(hs!==null) el.html.value = hs;
      const cs = localStorage.getItem('cc_v7_css');  if(cs!==null) el.css.value  = cs;
      const jsS = localStorage.getItem('cc_v7_js');  if(jsS!==null) el.js.value  = jsS;

      setAuto(true);
      setupSplitter();
      render();

      el.loadInput.addEventListener('change', (e)=>{
        const file = e.target.files && e.target.files[0]; if(!file) return;
        const ext = (file.name.split('.').pop()||'').toLowerCase();
        const reader = new FileReader();
        reader.onload = ()=>{
          const text = String(reader.result||'');
          try{
            if(ext==='json'){
              const data = JSON.parse(text);
              if(typeof data.html==='string') el.html.value = data.html;
              if(typeof data.css==='string')  el.css.value  = data.css;
              if(typeof data.js==='string')   el.js.value   = data.js;
            }else if(ext==='html' || ext==='htm'){ el.html.value = text; }
            else if(ext==='css'){ el.css.value = text; }
            else if(ext==='js'){ el.js.value = text; }
            else{
              const H = text.split(/===HTML===/i)[1], C = text.split(/===CSS===/i)[1], J = text.split(/===JS===/i)[1];
              if(H && C && J){ el.html.value = H.split(/===CSS===/i)[0].trim(); el.css.value = C.split(/===JS===/i)[0].trim(); el.js.value = J.trim(); }
              else { el.html.value = text; }
            }
            render();
          }catch(err){ alert('파일을 읽는 중 오류: JSON/TXT/HTML/CSS/JS를 지원합니다.'); }
        };
        reader.readAsText(file); e.target.value='';
      });

      document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); render(); } });
    }

    return { init, render, toggleAuto, toggleTheme, setDesktop, setMobile, switchTab, openDownload, closeDownload, confirmDownload, reset, hardReset };
  })();

  CC.init();
</script>
</body>
</html>